<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Editable Business Process Map - 3 Layers with Auto Spacing & Tooltips</title>
  <style>
    /* Full window with no scrollbars, black background */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
    }
    /* The SVG fills the window and acts like a map */
    svg {
      width: 100%;
      height: 100%;
      cursor: grab;
      background: #000;
    }
    /* Node Styles */
    .main-node {
      fill: transparent;
      stroke: #fff;
      stroke-width: 2px;
    }
    .sub-node {
      fill: transparent;
      stroke: #fff;
      stroke-width: 2px;
    }
    .sub-sub-node {
      fill: transparent;
      stroke: #fff;
      stroke-width: 2px;
    }
    .node-text {
      font-family: sans-serif;
      font-size: 14px;
      fill: #fff;
      text-anchor: middle;
      pointer-events: none;
    }
    .connector {
      stroke: rgba(255, 255, 255, 0.3);
      stroke-width: 2px;
      fill: none;
    }
    /* Tooltip styling */
    #tooltip {
      position: absolute;
      background: #fff;
      color: #000;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      pointer-events: none;
      display: none;
      font-family: sans-serif;
      font-size: 14px;
      z-index: 10;
    }
  </style>
</head>
<body>
  <svg id="map"></svg>
  <!-- Tooltip element -->
  <div id="tooltip"></div>
  <!-- Load D3.js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    // Set up SVG dimensions and main group.
    const width = window.innerWidth;
    const height = window.innerHeight;
    const svg = d3.select("#map").attr("width", width).attr("height", height);
    const g = svg.append("g");

    // Layout constants for sizes.
    const mainRadius = 50, subRadius = 20, subSubRadius = 5;
    const mainTextOffset = 20, subTextOffset = 20, subSubTextOffset = 20;

    // Spacing constants:
    // We'll use a single pass, so we only keep these for reference.
    const mainStartX = 100;      // x of the first main node
    const mainSpacing = 400;     // offset between entire branches
    const subOffsetX = 400;      // offset from main node to sub
    const subSpacingY = 350;     // vertical spacing for sub nodes
    const subSubOffsetX = 400;   // offset from sub node to sub-sub
    const subSubSpacingY = 125;  // vertical spacing for sub-sub nodes

    // ***********************
    // 1. Define Nodes
    // ***********************
    const mainNodes = [
      { id: "m1", type: "main", title: "A Business Exists", y: height/2, desc: "Foundational assumption: a business exists as an entity that provides value in exchange for resources." },
	  
      { id: "m2", type: "main", title: "Scans for Unmet Need / Opportunity", y: height/2, desc: "The business actively looks for things it can improve, fix, or create." },
	  
      { id: "m3", type: "main", title: "Selects Worthwhile Opportunities", y: height/2, desc: "Determines which discovered needs or opportunities are realistic, aligned with the business, and worth pursuing." },
	  
      { id: "m4", type: "main", title: "Prepares Selected Opportunities for Execution", y: height/2, desc: "Transitions a selected opportunity into a defined, actionable structure the business can begin working on." },
	  
	  { id: "m5", type: "main", title: "Transfers Prepared Work to Executers", y: height/2, desc: "Transfers fully prepared opportunities to the department, team, or individual best suited to execute them based on category, skills, and capacity — ensuring the right kind of work reaches the right kind of executor." },
	  
      { id: "m6", type: "main", title: "Executes Work", y: height/2, desc: "The assigned department or role carries out the necessary actions to fulfill the opportunity — transforming plans and inputs into tangible outputs, solutions, or value." },
	  
      { id: "m7", type: "main", title: "Reviews and Approves Work Internally", y: height/2, desc: "The completed work is submitted for internal review to ensure it meets quality, compliance, and alignment standards before final delivery. This step acts as a safeguard and final adjustment layer prior to external presentation or fulfillment." },
	  
      { id: "m8", type: "main", title: "Finalizes and Delivers the Output", y: height/2, desc: "The approved work is finalized into its completed form and delivered to the intended recipient — whether a client, customer, user, system, or partner — completing the cycle of value creation." },
	  
      { id: "m9", type: "main", title: "Reflects and Learns", y: height/2, desc: "After delivery, the business analyzes results, captures feedback, and identifies improvement areas to refine future work and deepen its understanding of how to better meet needs." },
	  
	  { id: "m10", type: "main", title: "Scans for Unmet Need / Opportunity", y: height/2, desc: "The business actively looks for things it can improve, fix, or create." },
	  
    ];

    // Sub nodes – naming "sXY" where X = parent's main node number.
    const subNodes = [
      { id: "s21", type: "sub", title: "Conducts Market Research", desc: "Actively seeks to understand what people want, need, or struggle with — revealing hidden gaps, demand patterns, or underserved customer segments the business can act on." },
      { id: "s22", type: "sub", title: "Observes Trends & Behaviors", desc: "Watches how people, industries, and cultures are changing — helping the business identify emerging needs or behavioral shifts that can be addressed before they go mainstream." },
      { id: "s23", type: "sub", title: "Analyzes Technology & Process Landscape", desc: "Explores how work is currently done and what tools are available — surfacing inefficiencies, limitations, or outdated systems that signal where innovation could create value." },
	  
	  { id: "s41", type: "sub", title: "Categorize the Opportunity", desc: "To determine what kind of effort it is (e.g. product development, client service, internal improvement) and where it should go." },
	  { id: "s42", type: "sub", title: "Define Scope and Objectives", desc: "To ensure everyone understands what is (and isn’t) included, and what success looks like." },
	  { id: "s43", type: "sub", title: "Allocate Resources and Roles", desc: "No execution happens without people, tools, time, and budget." },
	  { id: "s44", type: "sub", title: "Draft Initial Plan or Workflow", desc: "A rough outline prevents ambiguity and avoids chaos during execution." },
	  { id: "s45", type: "sub", title: "Identify Risks and Constraints", desc: "Anticipating blockers upfront prevents project derailment later." },
	  { id: "s46", type: "sub", title: "Confirm Stakeholder Expectations", desc: "Misaligned expectations lead to rework and wasted effort." },
	  { id: "s47", type: "sub", title: "Set Success Criteria", desc: "To know when the opportunity has been successfully addressed and when to call it done." },
	  
	  { id: "s61", type: "sub", title: "Gathers or Receives Required Inputs", desc: "Before work can begin, it must pull in the necessary data, materials, instructions, or access." },
      { id: "s62", type: "sub", title: "Performs Core Tasks", desc: "Executes the main action or function intended to fulfill the opportunity." },
      { id: "s63", type: "sub", title: "Collaborates Across Roles or Tools", desc: "Coordinates with others or integrates external tools and systems to complete the work." },
      { id: "s64", type: "sub", title: "Tracks Progress and Captures Output", desc: "Logs work completion, outputs, and metrics in progress-tracking or audit systems." },
	  { id: "s65", type: "sub", title: "Verifies Self-Quality Before Handoff", desc: "Before moving on to review, the executor ensures their own work is complete, correct, and ready to be checked." },
	  
	  { id: "s71", type: "sub", title: "Conducts Quality Assurance", desc: "The work is checked for defects, inconsistencies, or misalignment with standards." },
      { id: "s72", type: "sub", title: "Performs Peer or Cross-Team Review", desc: "Someone not directly involved in the execution reviews the output to offer a second perspective or identify missed issues." },
      { id: "s73", type: "sub", title: "Validates Against Original Requirements", desc: "Work is checked directly against the scope, deliverables, or success metrics defined earlier." },
	  { id: "s74", type: "sub", title: "Conducts Managerial or Final Sign-Off", desc: "Someone with final accountability (team lead, director, etc.) reviews and approves for release." },
	  { id: "s75", type: "sub", title: "Logs Approval and Prepares for Handoff", desc: "Once approved, the work is marked as ready and prepped for delivery to the client, customer, or next internal phase." },
      
	  { id: "s81", type: "sub", title: "Finalizes Output for Delivery", desc: "Transforms the approved work into its finished, polished, deliverable form." },
      { id: "s82", type: "sub", title: "Selects Delivery Channel or Method", desc: "Chooses the most appropriate method for delivery based on the recipient and context." },
      { id: "s83", type: "sub", title: "Delivers to Intended Recipient or System", desc: "Executes the actual delivery and transfers the value." },
	  { id: "s84", type: "sub", title: "Confirms Receipt and Acknowledgement", desc: "Ensures the recipient has received, accessed, or accepted the output." },
	  { id: "s85", type: "sub", title: "Archives Final Version or Proof of Delivery", desc: "Stores the output and proof of delivery for future reference or compliance." },
      
	  { id: "s91", type: "sub", title: "Collects Outcome Feedback", desc: "Gathers reactions, responses, and performance data from stakeholders, customers, or systems." },
      { id: "s92", type: "sub", title: "Measures Against Success Criteria", desc: "Compares results to what was defined as “success” during preparation." },
      { id: "s93", type: "sub", title: "Identifies Strengths and Shortcomings", desc: "Analyzes what worked well and what didn’t." },
	  { id: "s94", type: "sub", title: "Logs Learnings and Recommendations", desc: "Records key insights so future teams can reference them." },
	  { id: "s95", type: "sub", title: "Updates Systems and Practices", desc: "Makes process or documentation changes based on what was learned." },
      
    ];

    // Sub-sub nodes – naming "ssXYZ" where X = parent's main node, Y = parent's sub order.
    const subSubNodes = [
      { id: "ss211", type: "subsub", title: "Distributes Surveys / Runs Interviews", desc: "Collects firsthand insights directly from users or stakeholders to uncover pain points, desires, and blind spots not visible in data or trends." },
      { id: "ss212", type: "subsub", title: "Analyzes Sales & Churn Data", desc: "Identifies patterns in buying or drop-off behavior to detect dissatisfaction, friction, or gaps where needs aren’t being met." },
      { id: "ss213", type: "subsub", title: "Reviews Competitor Feedback", desc: "Surfaces unmet expectations by examining where competitors fall short — highlighting areas your business could serve better." },
      { id: "ss221", type: "subsub", title: "Scrapes Forums / Social Platforms", desc: "Gathers unfiltered discussions to reveal emerging frustrations, workarounds, or niche demands not yet addressed by the market." },
      { id: "ss222", type: "subsub", title: "Watches Keyword & Search Trends", desc: "Tracks what people are actively seeking — often revealing rising interest in solutions that don’t yet exist or are poorly served." },
      { id: "ss223", type: "subsub", title: "Follows Consumer Habits", desc: "Observes shifts in user preferences and routines that signal changing expectations — enabling the business to meet those needs early." },
      { id: "ss231", type: "subsub", title: "Tracks New APIs & Platforms", desc: "Scans for emerging technologies that can enable new services or solve problems in more scalable, modern ways." },
      { id: "ss232", type: "subsub", title: "Audits Standard Workflows", desc: "Reviews legacy or common processes to identify inefficiencies, bottlenecks, or outdated methods that are ripe for disruption." },
      { id: "ss233", type: "subsub", title: "Compares Operational Benchmarks", desc: "Highlights underperformance or excess effort compared to industry norms — revealing opportunities for smarter, leaner solutions." },
	  
	  { id: "ss411", type: "subsub", title: "Classifies by Business Function", desc: "Determines if the opportunity is marketing, engineering, sales, operations, etc." },
      { id: "ss412", type: "subsub", title: "Tags Complexity or Urgency", desc: "Assesses how urgent or complicated it is to determine level of effort and resource type." },
      { id: "ss413", type: "subsub", title: "Matches with Historical Work Archetypes", desc: "Compares it to past opportunities to apply proven strategies or templates." },
	  { id: "ss421", type: "subsub", title: "Clarifies Deliverables and Constraints", desc: "Outlines exactly what must be achieved and within what limitations." },
      { id: "ss422", type: "subsub", title: "Establishes Success Criteria", desc: "Defines how success will be measured and validated." },
      { id: "ss423", type: "subsub", title: "Confirms Stakeholder Agreements", desc: "Ensures internal/external parties are aligned before proceeding." },
      { id: "ss431", type: "subsub", title: "Assigns Ownership and Responsibility", desc: "Specifies who will lead and who will support different aspects." },
      { id: "ss432", type: "subsub", title: "Confirms Tool Access and Permissions", desc: "Verifies access to software, systems, or environments is in place." },
      { id: "ss433", type: "subsub", title: "Estimates Time and Budget Needs", desc: "Creates rough time and cost forecasts to ensure readiness." },
	  { id: "ss441", type: "subsub", title: "Outlines Major Phases or Milestones", desc: "Breaks work into manageable chunks and checkpoints." },
	  { id: "ss442", type: "subsub", title: "Maps Task Dependencies", desc: "Highlights what must happen before what to reduce blockers." },
	  { id: "ss443", type: "subsub", title: "Creates Visual or Written Workflow", desc: "Provides a visual or documented path the team will follow." },
	  { id: "ss451", type: "subsub", title: "Flags External Dependencies", desc: "Notes vendors, approvals, or systems the team depends on." },
	  { id: "ss452", type: "subsub", title: "Surfaces Legal, Compliance, or Policy Concerns", desc: "Checks for sensitive boundaries or required reviews." },
	  { id: "ss453", type: "subsub", title: "Identifies Known Technical Limitations", desc: "Notes system, integration, or capability risks." },
	  { id: "ss461", type: "subsub", title: "Holds Kickoff or Alignment Meeting", desc: "Aligns internal teams on the plan, goals, and responsibilities." },
	  { id: "ss462", type: "subsub", title: "Documents Commitments and Expectations", desc: "Creates shared written clarity to prevent misunderstandings later." },
	  { id: "ss463", type: "subsub", title: "Logs Stakeholder Sign-Off", desc: "Captures approvals needed to move from prep to execution." },
	  { id: "ss471", type: "subsub", title: "Chooses Leading & Lagging Metrics", desc: "Defines progress indicators and final outcome measurements." },
	  { id: "ss472", type: "subsub", title: "Creates Tracking or Dashboard Plan", desc: "Determines how results will be visualized or monitored." },
	  { id: "ss473", type: "subsub", title: "Aligns Metrics With Business Objectives", desc: "Ensures success metrics tie directly back to strategic value." },
	  
	  { id: "ss611", type: "subsub", title: "Retrieves Instructions, Briefs, or Requirements", desc: "Pulls relevant specs, SOPs, or customer requests needed to guide the task." },
      { id: "ss612", type: "subsub", title: "Collects Materials, Data, or Assets", desc: "Gathers physical components, datasets, digital files, or access credentials." },
      { id: "ss613", type: "subsub", title: "Verifies Input Completeness and Accuracy", desc: "Confirms that what was received is usable, up-to-date, and sufficient to proceed." },
      { id: "ss621", type: "subsub", title: "Applies Skills or Tools to Deliver Output", desc: "Uses the required technique, system, or labor to perform the actual work." },
      { id: "ss622", type: "subsub", title: "Follows Defined Workflow or Process", desc: "Executes the work using the agreed plan, SOP, or sequence." },
      { id: "ss623", type: "subsub", title: "Adapts to Unexpected Situations if Needed", desc: "Responds to real-time conditions, interruptions, or discoveries during execution." },
      { id: "ss631", type: "subsub", title: "Hands Off Partial Work for Contribution", desc: "Sends interim work to others for design, review, enhancement, or input." },
      { id: "ss632", type: "subsub", title: "Uses Integrated Tools, APIs, or Workflows", desc: "Connects and exchanges work between systems to continue execution fluidly." },
      { id: "ss633", type: "subsub", title: "Communicates Status or Needs in Real Time", desc: "Provides updates, asks for support, or clarifies expectations during the work." },
	  { id: "ss641", type: "subsub", title: "Saves and Stores Work in Agreed Location", desc: "Ensures outputs are findable, shareable, and version-controlled." },
	  { id: "ss642", type: "subsub", title: "Updates Task or Project Management Systems", desc: "Reflects current status in Jira, Asana, CRMs, spreadsheets, etc." },
	  { id: "ss643", type: "subsub", title: "Records Key Metrics or Completion Data", desc: "Captures quantitative or qualitative data about what was done or created." },
	  { id: "ss651", type: "subsub", title: "Cross-Checks Against Brief or Criteria", desc: "Compares output to instructions, quality standards, or acceptance criteria." },
	  { id: "ss652", type: "subsub", title: "Runs Basic Tests or Validations", desc: "Performs unit tests, formatting checks, or visual reviews depending on the work type." },
	  { id: "ss653", type: "subsub", title: "Makes Final Edits or Fixes", desc: "Resolves small issues proactively before others catch them later." },
      
	  { id: "ss711", type: "subsub", title: "Checks for Errors, Omissions, or Defects", desc: "Identifies mistakes, missing elements, or broken functionality in the output." },
      { id: "ss712", type: "subsub", title: "Confirms Adherence to Internal Standards", desc: "Ensures that branding, formatting, compliance, or safety standards are followed." },
      { id: "ss713", type: "subsub", title: "Tests Output in Relevant Environment", desc: "Runs simulations, unit tests, dry runs, or previews to validate that the work functions as expected." },
      { id: "ss721", type: "subsub", title: "Assigns Reviewer Not Involved in Execution", desc: "Ensures a fresh set of eyes evaluates the work without prior bias." },
      { id: "ss722", type: "subsub", title: "Collects Feedback and Suggested Changes", desc: "Reviewers provide input or identify areas needing refinement." },
      { id: "ss723", type: "subsub", title: "Iterates Based on Internal Collaboration", desc: "The executor incorporates internal feedback before moving on." },
      { id: "ss731", type: "subsub", title: "Cross-References Output with Scope or Brief", desc: "Ensures deliverables match what was initially promised or scoped." },
      { id: "ss732", type: "subsub", title: "Checks All Success Criteria Are Met", desc: "Validates measurable objectives, KPIs, or checklists." },
      { id: "ss733", type: "subsub", title: "Identifies Gaps or Overlooked Elements", desc: "Finds places where the output is incomplete, misaligned, or goes beyond what was needed." },
	  { id: "ss741", type: "subsub", title: "Escalates Work for Final Authority Review", desc: "The work is sent to a team lead, manager, or department head for final inspection." },
	  { id: "ss742", type: "subsub", title: "Assesses Strategic or Client Alignment", desc: "Confirms that the final output reflects the business's goals or the client's expectations." },
	  { id: "ss743", type: "subsub", title: "Signs Off or Requests Final Adjustments", desc: "Final call is made to approve or send the work back with mandatory changes." },
	  { id: "ss751", type: "subsub", title: "Marks Work as Approved in Tracking System", desc: "Updates the task, system, or pipeline to reflect completion." },
	  { id: "ss752", type: "subsub", title: "Packages Deliverables for Final Delivery", desc: "Zips files, compiles documents, or prepares assets into final form." },
	  { id: "ss753", type: "subsub", title: "Coordinates Handoff Timing and Channel", desc: "Aligns with whoever is delivering the work (e.g. client manager, publishing system, delivery driver)." },
      
	  { id: "ss811", type: "subsub", title: "Applies Final Formatting or Cleanup", desc: "Cleans up visuals, code, content, or product for professional delivery." },
      { id: "ss812", type: "subsub", title: "Converts Output into Required Format", desc: "Exports to PDF, deploys to live environment, compiles, zips, encodes, etc." },
      { id: "ss813", type: "subsub", title: "Runs Last Check Before Packaging", desc: "Quick sanity pass to ensure delivery-ready state (e.g., no placeholder text, links work, labels accurate)." },
      { id: "ss821", type: "subsub", title: "Evaluates Recipient’s Needs and Preferences", desc: "Considers what delivery method is best suited for the client, customer, or context." },
      { id: "ss822", type: "subsub", title: "Chooses Secure and Efficient Method", desc: "Balances speed, reliability, and privacy when picking delivery tech or path." },
      { id: "ss823", type: "subsub", title: "Prepares Channel for Use", desc: "Sets up email, FTP, access links, shipping label, or release window in advance." },
      { id: "ss831", type: "subsub", title: "Executes Transfer or Submission", desc: "Physically or digitally delivers the work (send, push, upload, ship, hand off)." },
      { id: "ss832", type: "subsub", title: "Includes Necessary Instructions or Context", desc: "Accompanies delivery with guidance, notes, login info, or usage instructions." },
      { id: "ss833", type: "subsub", title: "Ensures Access is Granted and Live", desc: "Confirms permissions are set, links work, or recipient can actually access the output." },
	  { id: "ss841", type: "subsub", title: "Notifies Stakeholder of Completion", desc: "Communicates “the work is done” to client, manager, or system." },
	  { id: "ss842", type: "subsub", title: "Requests or Monitors Confirmation", desc: "Watches for received messages, e-signatures, system pings, or explicit acceptance." },
	  { id: "ss843", type: "subsub", title: "Follows Up If Delivery Unacknowledged", desc: "Reaches out or retries if recipient hasn’t confirmed — ensuring closure." },
	  { id: "ss851", type: "subsub", title: "Saves Deliverable to Long-Term Storage", desc: "Stores final output in archive, repo, or internal system of record." },
	  { id: "ss852", type: "subsub", title: "Logs Delivery Timestamp and Method", desc: "Records who received what, when, and how for traceability and audit." },
	  { id: "ss853", type: "subsub", title: "Backs Up Files or Output Securely", desc: "Creates backups or versions in redundant, secure locations." },
      
	  { id: "ss911", type: "subsub", title: "Distributes Feedback Requests or Surveys", desc: "Sends out surveys, follow-ups, or automated pings to stakeholders or users." },
      { id: "ss912", type: "subsub", title: "Monitors Organic Feedback Channels", desc: "Reviews support tickets, social media, forums, or direct messages for insights." },
      { id: "ss913", type: "subsub", title: "Aggregates Quantitative & Qualitative Responses", desc: "Combines sentiment, ratings, and open comments for a balanced understanding." },
      { id: "ss921", type: "subsub", title: "Revisits Goals Defined During Preparation", desc: "Brings up original KPIs, targets, and constraints set in planning." },
      { id: "ss922", type: "subsub", title: "Compiles Post-Delivery Metrics or Logs", desc: "Pulls system data, engagement rates, timelines, or financial outcomes." },
      { id: "ss923", type: "subsub", title: "Compares Results to Benchmarks or Thresholds", desc: "Measures results against industry norms, client expectations, or past performance." },
      { id: "ss931", type: "subsub", title: "Runs Internal Team Debrief", desc: "Brings together the delivery team to reflect on what went well or poorly." },
      { id: "ss932", type: "subsub", title: "Surfaces Process or Communication Breakdowns", desc: "Identifies missteps like unclear handoffs, rework loops, or resource conflicts." },
      { id: "ss933", type: "subsub", title: "Highlights High-Impact Success Factors", desc: "Pinpoints actions, tools, or choices that led to major wins." },
	  { id: "ss941", type: "subsub", title: "Writes Up Lessons Learned Summary", desc: "Creates a brief but clear record of key takeaways from this cycle." },
	  { id: "ss942", type: "subsub", title: "Links Outcomes to Specific Actions or Decisions", desc: "Ties results back to what enabled or blocked them for future guidance." },
	  { id: "ss943", type: "subsub", title: "Tags Learnings for Future Retrieval", desc: "Makes insights searchable or easy to surface during similar future work." },
	  { id: "ss951", type: "subsub", title: "Improves Documentation or Templates", desc: "Refines checklists, briefs, onboarding docs, or SOPs based on experience." },
	  { id: "ss952", type: "subsub", title: "Implements New Tools or Adjustments", desc: "Adds or retires software, automation, or processes to boost efficiency." },
	  { id: "ss953", type: "subsub", title: "Shares Improvements with the Org", desc: "Communicates changes or wins to other teams — creating a culture of learning." },

    ];

    // We'll create quick lookups for sub nodes and sub-sub nodes so we can easily filter by parent.
    function getSubsForMain(mId) {
      // e.g. "m2" => sub nodes with id "s2..."
      const digit = mId.substring(1);
      return subNodes.filter(n => n.id.charAt(1) === digit);
    }
    function getSubSubsForSub(sId) {
      // e.g. "s31" => sub-sub with "ss311", "ss312", ...
      const key = sId.substring(1); // "31"
      return subSubNodes.filter(n => n.id.substring(2,4) === key);
    }

    // ***********************
    // Single-pass layout logic
    // ***********************

    // 1) Place the first main node at a fixed x.
    mainNodes[0].x = mainStartX;

    // Helper: place sub nodes for a given main node and return the rightmost x.
    function placeSubBranch(mainNode) {
      // Find all sub nodes belonging to this main node.
      const subs = getSubsForMain(mainNode.id);
      if (!subs.length) return mainNode.x;  // no sub => no further to the right

      // Space them vertically around mainNode.y
      const n = subs.length;
      subs.forEach((sub, i) => {
        sub.x = mainNode.x + subOffsetX;  // place to the right of the main node
        sub.y = mainNode.y + (i - (n - 1) / 2) * subSpacingY;
      });

      // Now place each sub-sub branch. We'll track the rightmost x across all sub nodes.
      let rightMost = mainNode.x;
      subs.forEach(sub => {
        const subSubs = getSubSubsForSub(sub.id);
        if (!subSubs.length) {
          // no sub-sub => check sub.x
          if (sub.x > rightMost) rightMost = sub.x;
          return;
        }
        // We have sub-sub nodes. Place them horizontally in a vertical arrangement around sub.y.
        const countSS = subSubs.length;
        subSubs.forEach((ss, idx) => {
          ss.x = sub.x + subSubOffsetX;
          ss.y = sub.y + (idx - (countSS - 1) / 2) * subSubSpacingY;
        });
        // The rightmost sub-sub is at x = sub.x + subSubOffsetX
        // But if we want them chained horizontally, we'd do more logic. 
        // For now, they line up vertically. So let's see how far they get:
        const thisRight = subSubs[0].x; // all the same x in this approach
        if (thisRight > rightMost) rightMost = thisRight;
      });

      return rightMost;
    }

    // 2) For each main node in order, place its sub & sub-sub, track the rightmost x, 
    //    and position the next main node.
    let currentRight = placeSubBranch(mainNodes[0]);
    for (let i = 1; i < mainNodes.length; i++) {
      // put mainNodes[i] to the right of currentRight
      mainNodes[i].x = currentRight + mainSpacing;
      // now place its sub branch
      const newRight = placeSubBranch(mainNodes[i]);
      // update currentRight
      currentRight = Math.max(currentRight, newRight, mainNodes[i].x);
    }

    // Now we have x & y for all nodes in a single pass. 
    // Create a lookup for connections.
    const allNodesCombined = mainNodes.concat(subNodes, subSubNodes);
    const nodeById = {};
    allNodesCombined.forEach(n => nodeById[n.id] = n);

    // ***********************
    // 2. Define Connections
    // ***********************
    const connections = [
      { source: "m1", target: "m2" },
	  
      { source: "m2", target: "s21" },
	  { source: "s21", target: "ss211" },
      { source: "s21", target: "ss212" },
      { source: "s21", target: "ss213" },
      { source: "m2", target: "s22" },
	  { source: "s22", target: "ss221" },
      { source: "s22", target: "ss222" },
      { source: "s22", target: "ss223" },
      { source: "m2", target: "s23" },
      { source: "s23", target: "ss231" },
      { source: "s23", target: "ss232" },
      { source: "s23", target: "ss233" },
      { source: "ss211", target: "m3" },
      { source: "ss212", target: "m3" },
      { source: "ss213", target: "m3" },
      { source: "ss221", target: "m3" },
      { source: "ss222", target: "m3" },
      { source: "ss223", target: "m3" },
      { source: "ss231", target: "m3" },
      { source: "ss232", target: "m3" },
      { source: "ss233", target: "m3" },
	  
	  { source: "m3", target: "m4" },
	  
	  { source: "m4", target: "s41" },
	  { source: "s41", target: "ss411" },
	  { source: "s41", target: "ss412" },
	  { source: "s41", target: "ss413" },
	  { source: "m4", target: "s42" },
	  { source: "s42", target: "ss421" },
	  { source: "s42", target: "ss422" },
	  { source: "s42", target: "ss423" },
	  { source: "m4", target: "s43" },
	  { source: "s43", target: "ss431" },
	  { source: "s43", target: "ss432" },
	  { source: "s43", target: "ss433" },
	  { source: "m4", target: "s44" },
	  { source: "s44", target: "ss441" },
	  { source: "s44", target: "ss442" },
	  { source: "s44", target: "ss443" },
	  { source: "m4", target: "s45" },
	  { source: "s45", target: "ss451" },
	  { source: "s45", target: "ss452" },
	  { source: "s45", target: "ss453" },
	  { source: "m4", target: "s46" },
	  { source: "s46", target: "ss461" },
	  { source: "s46", target: "ss462" },
	  { source: "s46", target: "ss463" },
	  { source: "m4", target: "s47" },
	  { source: "s47", target: "ss471" },
	  { source: "s47", target: "ss472" },
	  { source: "s47", target: "ss473" },
	  { source: "ss411", target: "m5" },
	  { source: "ss412", target: "m5" },
	  { source: "ss413", target: "m5" },
	  { source: "ss421", target: "m5" },
	  { source: "ss422", target: "m5" },
	  { source: "ss423", target: "m5" },
	  { source: "ss431", target: "m5" },
	  { source: "ss432", target: "m5" },
	  { source: "ss433", target: "m5" },
	  { source: "ss441", target: "m5" },
	  { source: "ss442", target: "m5" },
	  { source: "ss443", target: "m5" },
	  { source: "ss451", target: "m5" },
	  { source: "ss452", target: "m5" },
	  { source: "ss453", target: "m5" },
	  { source: "ss461", target: "m5" },
	  { source: "ss462", target: "m5" },
	  { source: "ss463", target: "m5" },
	  { source: "ss471", target: "m5" },
	  { source: "ss472", target: "m5" },
	  { source: "ss473", target: "m5" },
	  
	  { source: "m5", target: "m6" },
	  
	  { source: "m6", target: "s61" },
	  { source: "s61", target: "ss611" },
	  { source: "s61", target: "ss612" },
	  { source: "s61", target: "ss613" },
	  { source: "m6", target: "s62" },
	  { source: "s62", target: "ss621" },
	  { source: "s62", target: "ss622" },
	  { source: "s62", target: "ss623" },
	  { source: "m6", target: "s63" },
	  { source: "s63", target: "ss631" },
	  { source: "s63", target: "ss632" },
	  { source: "s63", target: "ss633" },
	  { source: "m6", target: "s64" },
	  { source: "s64", target: "ss641" },
	  { source: "s64", target: "ss642" },
	  { source: "s64", target: "ss643" },
	  { source: "m6", target: "s65" },
	  { source: "s65", target: "ss651" },
	  { source: "s65", target: "ss652" },
	  { source: "s65", target: "ss653" },
	  { source: "ss611", target: "m7" },
	  { source: "ss612", target: "m7" },
	  { source: "ss613", target: "m7" },
	  { source: "ss621", target: "m7" },
	  { source: "ss622", target: "m7" },
	  { source: "ss623", target: "m7" },
	  { source: "ss631", target: "m7" },
	  { source: "ss632", target: "m7" },
	  { source: "ss633", target: "m7" },
	  { source: "ss641", target: "m7" },
	  { source: "ss642", target: "m7" },
	  { source: "ss643", target: "m7" },
	  { source: "ss651", target: "m7" },
	  { source: "ss652", target: "m7" },
	  { source: "ss653", target: "m7" },
	  
	  { source: "m7", target: "s71" },
	  { source: "s71", target: "ss711" },
	  { source: "s71", target: "ss712" },
	  { source: "s71", target: "ss713" },
	  { source: "m7", target: "s72" },
	  { source: "s72", target: "ss721" },
	  { source: "s72", target: "ss722" },
	  { source: "s72", target: "ss723" },
	  { source: "m7", target: "s73" },
	  { source: "s73", target: "ss731" },
	  { source: "s73", target: "ss732" },
	  { source: "s73", target: "ss733" },
	  { source: "m7", target: "s74" },
	  { source: "s74", target: "ss741" },
	  { source: "s74", target: "ss742" },
	  { source: "s74", target: "ss743" },
	  { source: "m7", target: "s75" },
	  { source: "s75", target: "ss751" },
	  { source: "s75", target: "ss752" },
	  { source: "s75", target: "ss753" },
	  { source: "ss711", target: "m8" },
	  { source: "ss712", target: "m8" },
	  { source: "ss713", target: "m8" },
	  { source: "ss721", target: "m8" },
	  { source: "ss722", target: "m8" },
	  { source: "ss723", target: "m8" },
	  { source: "ss731", target: "m8" },
	  { source: "ss732", target: "m8" },
	  { source: "ss733", target: "m8" },
	  { source: "ss741", target: "m8" },
	  { source: "ss742", target: "m8" },
	  { source: "ss743", target: "m8" },
	  { source: "ss751", target: "m8" },
	  { source: "ss752", target: "m8" },
	  { source: "ss753", target: "m8" },
	  
	  { source: "m8", target: "s81" },
	  { source: "s81", target: "ss811" },
	  { source: "s81", target: "ss812" },
	  { source: "s81", target: "ss813" },
	  { source: "m8", target: "s82" },
	  { source: "s82", target: "ss821" },
	  { source: "s82", target: "ss822" },
	  { source: "s82", target: "ss823" },
	  { source: "m8", target: "s83" },
	  { source: "s83", target: "ss831" },
	  { source: "s83", target: "ss832" },
	  { source: "s83", target: "ss833" },
	  { source: "m8", target: "s84" },
	  { source: "s84", target: "ss841" },
	  { source: "s84", target: "ss842" },
	  { source: "s84", target: "ss843" },
	  { source: "m8", target: "s85" },
	  { source: "s85", target: "ss851" },
	  { source: "s85", target: "ss852" },
	  { source: "s85", target: "ss853" },
	  { source: "ss811", target: "m9" },
	  { source: "ss812", target: "m9" },
	  { source: "ss813", target: "m9" },
	  { source: "ss821", target: "m9" },
	  { source: "ss822", target: "m9" },
	  { source: "ss823", target: "m9" },
	  { source: "ss831", target: "m9" },
	  { source: "ss832", target: "m9" },
	  { source: "ss833", target: "m9" },
	  { source: "ss841", target: "m9" },
	  { source: "ss842", target: "m9" },
	  { source: "ss843", target: "m9" },
	  { source: "ss851", target: "m9" },
	  { source: "ss852", target: "m9" },
	  { source: "ss853", target: "m9" },
	  
	  { source: "m9", target: "s91" },
	  { source: "s91", target: "ss911" },
	  { source: "s91", target: "ss912" },
	  { source: "s91", target: "ss913" },
	  { source: "m9", target: "s92" },
	  { source: "s92", target: "ss921" },
	  { source: "s92", target: "ss922" },
	  { source: "s92", target: "ss923" },
	  { source: "m9", target: "s93" },
	  { source: "s93", target: "ss931" },
	  { source: "s93", target: "ss932" },
	  { source: "s93", target: "ss933" },
	  { source: "m9", target: "s94" },
	  { source: "s94", target: "ss941" },
	  { source: "s94", target: "ss942" },
	  { source: "s94", target: "ss943" },
	  { source: "m9", target: "s95" },
	  { source: "s95", target: "ss951" },
	  { source: "s95", target: "ss952" },
	  { source: "s95", target: "ss953" },
	  { source: "ss911", target: "m10" },
	  { source: "ss912", target: "m10" },
	  { source: "ss913", target: "m10" },
	  { source: "ss921", target: "m10" },
	  { source: "ss922", target: "m10" },
	  { source: "ss923", target: "m10" },
	  { source: "ss931", target: "m10" },
	  { source: "ss932", target: "m10" },
	  { source: "ss933", target: "m10" },
	  { source: "ss941", target: "m10" },
	  { source: "ss942", target: "m10" },
	  { source: "ss943", target: "m10" },
	  { source: "ss951", target: "m10" },
	  { source: "ss952", target: "m10" },
	  { source: "ss953", target: "m10" },

    ];

    // ***********************
    // 3. Draw the Nodes and Labels
    // ***********************
    g.selectAll("circle.main")
      .data(mainNodes)
      .enter()
      .append("circle")
      .attr("class", "main-node")
      .attr("cx", d => d.x)
      .attr("cy", d => d.y)
      .attr("r", mainRadius);

    g.selectAll("text.main")
      .data(mainNodes)
      .enter()
      .append("text")
      .attr("class", "node-text")
      .attr("x", d => d.x)
      .attr("y", d => d.y + mainRadius + mainTextOffset)
      .text(d => d.title);

    g.selectAll("circle.sub")
      .data(subNodes)
      .enter()
      .append("circle")
      .attr("class", "sub-node")
      .attr("cx", d => d.x)
      .attr("cy", d => d.y)
      .attr("r", subRadius);

    g.selectAll("text.sub")
      .data(subNodes)
      .enter()
      .append("text")
      .attr("class", "node-text")
      .attr("x", d => d.x)
      .attr("y", d => d.y + subRadius + subTextOffset)
      .text(d => d.title);

    g.selectAll("circle.subsub")
      .data(subSubNodes)
      .enter()
      .append("circle")
      .attr("class", "sub-sub-node")
      .attr("cx", d => d.x)
      .attr("cy", d => d.y)
      .attr("r", subSubRadius);

    g.selectAll("text.subsub")
      .data(subSubNodes)
      .enter()
      .append("text")
      .attr("class", "node-text")
      .attr("x", d => d.x)
      .attr("y", d => d.y + subSubRadius + subSubTextOffset)
      .text(d => d.title);

    // ***********************
    // 4. Draw the Connections
    // ***********************
    function getRadius(node) {
      if (node.type === "main") return mainRadius;
      else if (node.type === "sub") return subRadius;
      else if (node.type === "subsub") return subSubRadius;
      else return subRadius;
    }
    function computeConnectionEndpoints(source, target) {
      const dx = target.x - source.x;
      const dy = target.y - source.y;
      const angle = Math.atan2(dy, dx);
      const sourceRadius = getRadius(source);
      const targetRadius = getRadius(target);
      const startX = source.x + Math.cos(angle) * sourceRadius;
      const startY = source.y + Math.sin(angle) * sourceRadius;
      const endX = target.x - Math.cos(angle) * targetRadius;
      const endY = target.y - Math.sin(angle) * targetRadius;
      return { startX, startY, endX, endY };
    }

    connections.forEach(conn => {
      const sourceNode = nodeById[conn.source];
      const targetNode = nodeById[conn.target];
      if (sourceNode && targetNode) {
        const { startX, startY, endX, endY } = computeConnectionEndpoints(sourceNode, targetNode);
        g.append("line")
         .attr("class", "connector")
         .attr("x1", startX)
         .attr("y1", startY)
         .attr("x2", endX)
         .attr("y2", endY);
      }
    });

    // ***********************
    // 5. Add Tooltip Functionality
    // ***********************
    const tooltip = d3.select("#tooltip");
    g.selectAll("circle.main-node, circle.sub-node, circle.sub-sub-node")
      .on("mouseover", function(event, d) {
        tooltip.style("display", "block")
               .html(d.desc || d.title);
        tooltip.style("left", (event.pageX + 10) + "px")
               .style("top", (event.pageY + 10) + "px");
      })
      .on("mousemove", function(event) {
        tooltip.style("left", (event.pageX + 10) + "px")
               .style("top", (event.pageY + 10) + "px");
      })
      .on("mouseout", function() {
        tooltip.style("display", "none");
      });

    // ***********************
    // 6. Enable Pan and Zoom
    // ***********************
    const zoomBehavior = d3.zoom()
                           .scaleExtent([0.5, 3])
                           .on("zoom", event => {
                             g.attr("transform", event.transform);
                           });
    svg.call(zoomBehavior)
       .on("start.zoom", () => svg.style("cursor", "grabbing"))
       .on("end.zoom", () => svg.style("cursor", "grab"));

  </script>
</body>
</html>
