<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Editable Business Process Map - 3 Layers with Auto Spacing & Tooltips</title>
  <style>
    /* Full window with no scrollbars, black background */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
    }
    /* The SVG fills the window and acts like a map */
    svg {
      width: 100%;
      height: 100%;
      cursor: grab;
      background: #000;
    }
    /* Node Styles */
    .main-node {
      fill: transparent;
      stroke: #fff;
      stroke-width: 2px;
    }
    .sub-node {
      fill: transparent;
      stroke: #fff;
      stroke-width: 2px;
    }
    .sub-sub-node {
      fill: transparent;
      stroke: #fff;
      stroke-width: 2px;
    }
    .node-text {
      font-family: sans-serif;
      font-size: 14px;
      fill: #fff;
      text-anchor: middle;
      pointer-events: none;
    }
    .connector {
      stroke: rgba(255, 255, 255, 0.3);
      stroke-width: 2px;
      fill: none;
    }
    /* Tooltip styling */
    #tooltip {
      position: absolute;
      background: #fff;
      color: #000;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      pointer-events: none;
      display: none;
      font-family: sans-serif;
      font-size: 14px;
      z-index: 10;
    }
  </style>
</head>
<body>
  <svg id="map"></svg>
  <!-- Tooltip element -->
  <div id="tooltip"></div>
  <!-- Load D3.js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    // Set up SVG dimensions and main group.
    const width = window.innerWidth;
    const height = window.innerHeight;
    const svg = d3.select("#map").attr("width", width).attr("height", height);
    const g = svg.append("g");

    // Layout constants for sizes.
    const mainRadius = 50, subRadius = 20, subSubRadius = 5;
    const mainTextOffset = 20, subTextOffset = 20, subSubTextOffset = 20;

    // Spacing constants:
    // We'll use a single pass, so we only keep these for reference.
    const mainStartX = 100;      // x of the first main node
    const mainSpacing = 400;     // offset between entire branches
    const subOffsetX = 400;      // offset from main node to sub
    const subSpacingY = 350;     // vertical spacing for sub nodes
    const subSubOffsetX = 400;   // offset from sub node to sub-sub
    const subSubSpacingY = 125;  // vertical spacing for sub-sub nodes

    // ***********************
    // 1. Define Nodes
    // ***********************
    const mainNodes = [
      { id: "m1", type: "main", title: "A Business Exists", y: height/2, desc: "Foundational assumption: a business exists as an entity that provides value in exchange for resources." },
      { id: "m2", type: "main", title: "Scans for Unmet Need / Opportunity", y: height/2, desc: "The business actively looks for things it can improve, fix, or create." },
      { id: "m3", type: "main", title: "Selects Worthwhile Opportunities", y: height/2, desc: "Determines which discovered needs or opportunities are realistic, aligned with the business, and worth pursuing." },
      { id: "m4", type: "main", title: "Prepares Opportunity for Work", y: height/2, desc: "Transitions a selected opportunity into a defined, actionable structure the business can begin working on." },
	  { id: "m5", type: "main", title: "Categorizes the Work", y: height/2, desc: "Classifies the prepared opportunity so it can be understood, routed, and worked on effectively." },
      { id: "m6", type: "main", title: "Routes Work to Appropriate Department or Role", y: height/2, desc: "Directs categorized work to the department or individual best equipped to handle it." },
      { id: "m7", type: "main", title: "Performs the Work", y: height/2, desc: "Executes the defined process to address the opportunity and generate value." },
      { id: "m8", type: "main", title: "Reviews and Approves Work Internally", y: height/2, desc: "Validates the work quality and completeness before it is finalized or shared externally." },
      { id: "m9", type: "main", title: "Finalizes and Delivers the Output", y: height/2, desc: "Completes any final touches and delivers the finished work to the client or intended recipient." },
      { id: "m10", type: "main", title: "Reflects and Learns", y: height/2, desc: "Analyzes results and feedback to improve future execution and strategy." },
    ];

    // Sub nodes – naming "sXY" where X = parent's main node number.
    const subNodes = [
      { id: "s21", type: "sub", title: "Conducts Market Research", desc: "Actively seeks to understand what people want, need, or struggle with — revealing hidden gaps, demand patterns, or underserved customer segments the business can act on." },
      { id: "s22", type: "sub", title: "Observes Trends & Behaviors", desc: "Watches how people, industries, and cultures are changing — helping the business identify emerging needs or behavioral shifts that can be addressed before they go mainstream." },
      { id: "s23", type: "sub", title: "Analyzes Technology & Process Landscape", desc: "Explores how work is currently done and what tools are available — surfacing inefficiencies, limitations, or outdated systems that signal where innovation could create value." },
      { id: "s31", type: "sub", title: "Assesses Feasibility", desc: "Does the company have (or can it realistically gain) the technical ability, resources, and access?" },
      { id: "s32", type: "sub", title: "Evaluates Strategic Fit", desc: "Will this opportunity strengthen the company’s core position or direction?" },
      { id: "s33", type: "sub", title: "Scores Potential Value & Impact", desc: "How big is the opportunity in terms of revenue, reach, differentiation, or social impact?" },
	  { id: "s41", type: "sub", title: "Defines Scope and Objectives", desc: "Clarifies exactly what the business intends to accomplish and why — creating alignment." },
	  { id: "s42", type: "sub", title: "Allocates Resources and Roles", desc: "Assigns people, tools, time, and budget to the opportunity to make it real." },
	  { id: "s43", type: "sub", title: "Designs Initial Approach or Plan", desc: "Develops a first-pass plan, process, or workflow — sketching how the opportunity will be tackled." },
	  { id: "s51", type: "sub", title: "Classifies Work Type", desc: "Determines what category or domain the work falls under — product, service, issue, campaign, etc." },
      { id: "s52", type: "sub", title: "Analyzes Requirements and Dependencies", desc: "Understands the inputs, formats, data, people, or systems the work relies on." },
      { id: "s53", type: "sub", title: "Determines Processing Method", desc: "Decides the most appropriate workflow, automation level, or delivery method." },
      { id: "s61", type: "sub", title: "Matches Work to Capabilities", desc: "Aligns the work type and complexity with the right person or team." },
      { id: "s62", type: "sub", title: "Routes via Workflow Engine", desc: "Uses automation or predefined rules to send work where it needs to go." },
      { id: "s63", type: "sub", title: "Handles Exceptions or Escalations", desc: "Manages special cases, urgent needs, or ambiguous routing scenarios." },
      { id: "s71", type: "sub", title: "Executes Assigned Task", desc: "Carries out the core function intended to address the opportunity." },
      { id: "s72", type: "sub", title: "Collaborates Across Teams", desc: "Involves others as needed to gather inputs or co-produce outputs." },
      { id: "s73", type: "sub", title: "Logs Progress and Output", desc: "Documents what was done and what resulted — creating traceability." },
      { id: "s81", type: "sub", title: "Performs Quality Control", desc: "Checks the work against defined quality standards or metrics." },
      { id: "s82", type: "sub", title: "Conducts Peer or Supervisor Review", desc: "Has another person validate correctness, completeness, and compliance." },
      { id: "s83", type: "sub", title: "Collects Internal Approval", desc: "Gathers required sign-offs or confirmations before proceeding." },
      { id: "s91", type: "sub", title: "Finalizes Work Product", desc: "Applies last-stage polish, formatting, and finishing touches." },
      { id: "s92", type: "sub", title: "Prepares for Delivery", desc: "Packages the work in the right form for the client or audience." },
      { id: "s93", type: "sub", title: "Delivers or Deploys Output", desc: "Sends, ships, presents, or deploys the finished work." },
      //{ id: "s101", type: "sub", title: "Analyzes Results and Outcomes", desc: "Looks at the actual impact or performance of the delivered work." },
      //{ id: "s102", type: "sub", title: "Gathers Feedback", desc: "Collects reactions, reviews, or insights from clients or stakeholders." },
      //{ id: "s103", type: "sub", title: "Updates Knowledge Base or SOPs", desc: "Captures learnings in reusable form to improve future operations." },
    ];

    // Sub-sub nodes – naming "ssXYZ" where X = parent's main node, Y = parent's sub order.
    const subSubNodes = [
      { id: "ss211", type: "subsub", title: "Distributes Surveys / Runs Interviews", desc: "Collects firsthand insights directly from users or stakeholders to uncover pain points, desires, and blind spots not visible in data or trends." },
      { id: "ss212", type: "subsub", title: "Analyzes Sales & Churn Data", desc: "Identifies patterns in buying or drop-off behavior to detect dissatisfaction, friction, or gaps where needs aren’t being met." },
      { id: "ss213", type: "subsub", title: "Reviews Competitor Feedback", desc: "Surfaces unmet expectations by examining where competitors fall short — highlighting areas your business could serve better." },
      { id: "ss221", type: "subsub", title: "Scrapes Forums / Social Platforms", desc: "Gathers unfiltered discussions to reveal emerging frustrations, workarounds, or niche demands not yet addressed by the market." },
      { id: "ss222", type: "subsub", title: "Watches Keyword & Search Trends", desc: "Tracks what people are actively seeking — often revealing rising interest in solutions that don’t yet exist or are poorly served." },
      { id: "ss223", type: "subsub", title: "Follows Consumer Habits", desc: "Observes shifts in user preferences and routines that signal changing expectations — enabling the business to meet those needs early." },
      { id: "ss231", type: "subsub", title: "Tracks New APIs & Platforms", desc: "Scans for emerging technologies that can enable new services or solve problems in more scalable, modern ways." },
      { id: "ss232", type: "subsub", title: "Audits Standard Workflows", desc: "Reviews legacy or common processes to identify inefficiencies, bottlenecks, or outdated methods that are ripe for disruption." },
      { id: "ss233", type: "subsub", title: "Compares Operational Benchmarks", desc: "Highlights underperformance or excess effort compared to industry norms — revealing opportunities for smarter, leaner solutions." },
      { id: "ss311", type: "subsub", title: "Checks Technical Requirements", desc: "Evaluates whether the opportunity requires new systems, integrations, or R&D, revealing potential blockers or needed investments." },
      { id: "ss312", type: "subsub", title: "Estimates Time & Resources", desc: "Projects what level of staffing, timeline, and materials would be needed — helping ensure the company doesn’t overcommit or underdeliver." },
      { id: "ss313", type: "subsub", title: "Analyzes Risk & Constraints", desc: "Identifies legal, operational, or competitive risks that could prevent success — enabling smarter go/no-go decisions." },
      { id: "ss321", type: "subsub", title: "Checks Brand & Mission Alignment", desc: "Ensures the opportunity fits the company’s identity and long-term direction — increasing coherence and trust." },
      { id: "ss322", type: "subsub", title: "Reviews Internal Capability Match", desc: "Compares the work required with existing team strengths — identifying synergy or the need for upskilling." },
      { id: "ss323", type: "subsub", title: "Tests Long-Term Scalability", desc: "Forecasts how the opportunity could grow — preventing wasted effort on short-lived wins or non-repeatable services." },
      { id: "ss331", type: "subsub", title: "Estimates Revenue or Cost Savings", desc: "Forecasts potential profit or efficiency gains — helping prioritize opportunities with measurable returns." },
      { id: "ss332", type: "subsub", title: "Evaluates Market Timing & Demand", desc: "Looks at how urgent the need is and whether the market is ready — helping avoid being too early, too late, or out of sync." },
      { id: "ss333", type: "subsub", title: "Weighs Competitive Advantage", desc: "Assesses whether the business can deliver this better, faster, or differently — identifying chances to win uniquely." },
	  { id: "ss411", type: "subsub", title: "Clarifies Deliverables and Constraints", desc: "Outlines what the end result must include, and what boundaries or limits exist — preventing scope creep or misalignment." },
	  { id: "ss412", type: "subsub", title: "Identifies Success Metrics", desc: "Sets measurable goals or indicators to track progress and determine if the need has been met." },
	  { id: "ss413", type: "subsub", title: "Confirms Stakeholder Expectations", desc: "Ensures all internal and external stakeholders agree on what is being done and why — reducing miscommunication later." },
	  { id: "ss421", type: "subsub", title: "Assigns Task Ownership", desc: "Specifies who will be responsible for each part of the work — improving clarity and accountability." },
	  { id: "ss422", type: "subsub", title: "Confirms Tool and Access Requirements", desc: "Ensures teams have what they need to start working — avoiding delays from missing software, credentials, or systems." },
	  { id: "ss423", type: "subsub", title: "Reserves Time and Budget", desc: "Allocates enough bandwidth and funds to begin — reducing friction and ensuring commitment." },
	  { id: "ss431", type: "subsub", title: "Outlines High-Level Workflow", desc: "Sketches the major steps, sequence, and logic behind how the opportunity will be tackled." },
	  { id: "ss432", type: "subsub", title: "Builds Rough Timeline or Milestones", desc: "Adds time-based structure so stakeholders can plan around the work and know what to expect." },
	  { id: "ss433", type: "subsub", title: "Identifies Potential Blockers Early", desc: "Flags known or likely obstacles so that mitigation strategies can be built in from the start." },
	  { id: "ss511", type: "subsub", title: "Identifies Business Function Area", desc: "Determines if the work belongs to finance, HR, product, marketing, etc., so it can follow the right protocols." },
      { id: "ss512", type: "subsub", title: "Labels by Intent or Output Type", desc: "Recognizes whether the work is about fixing, building, analyzing, informing, or delivering." },
      { id: "ss513", type: "subsub", title: "Groups by Complexity or Priority", desc: "Tags the work as simple, complex, urgent, or routine to influence how it's handled downstream." },
	  { id: "ss521", type: "subsub", title: "Distinguishes Between Strategic vs. Operational", desc: "Determines whether the work contributes to long-term goals or short-term tasks — guiding how it's prioritized and handled." },
      { id: "ss522", type: "subsub", title: "Assigns a Domain Tag (e.g. Finance, HR)", desc: "Applies a consistent taxonomy to ensure work is routed and reported correctly." },
      { id: "ss523", type: "subsub", title: "Flags for Cross-Functional Involvement", desc: "Detects work that touches multiple business areas, so broader coordination can be planned." },
      { id: "ss531", type: "subsub", title: "Chooses Between Manual vs. Automated Processing", desc: "Evaluates whether the task is best handled by humans, software, or a hybrid approach." },
      { id: "ss532", type: "subsub", title: "Selects Appropriate Tools or Platforms", desc: "Identifies which internal or third-party systems should be used to complete the work." },
      { id: "ss533", type: "subsub", title: "Determines Need for Approval Layers", desc: "Decides how many levels of review or sign-off are required before work can proceed." },
	  { id: "ss611", type: "subsub", title: "Tags Required Expertise", desc: "Identifies what skills or qualifications are needed to complete the work effectively." },
      { id: "ss612", type: "subsub", title: "References Role Directory", desc: "Uses an internal directory or skill matrix to find appropriate handlers." },
      { id: "ss613", type: "subsub", title: "Adjusts for Workload Capacity", desc: "Takes into account current availability or queue of each team or person." },
      { id: "ss621", type: "subsub", title: "Uses Rules-Based Routing", desc: "Applies workflow logic or decision trees to route standard cases automatically." },
      { id: "ss622", type: "subsub", title: "Triggers Event-Based Logic", desc: "Routes work based on triggers like deadlines, volumes, or status changes." },
      { id: "ss623", type: "subsub", title: "Logs Routing Decisions", desc: "Records routing logic for traceability, transparency, and auditing." },
      { id: "ss631", type: "subsub", title: "Flags Out-of-Scope Requests", desc: "Detects work types that don’t fit the standard structure and raises alerts." },
      { id: "ss632", type: "subsub", title: "Sends to Human Escalation", desc: "Passes edge cases to supervisors or subject-matter experts for review." },
      { id: "ss633", type: "subsub", title: "Records Manual Overrides", desc: "Captures when routing is handled by discretion instead of automation." },
      { id: "ss711", type: "subsub", title: "Follows Standard Operating Procedures", desc: "Uses documented SOPs to ensure consistency and reliability." },
      { id: "ss712", type: "subsub", title: "Tracks Execution Time", desc: "Measures how long the work takes — enabling benchmarking or optimization." },
      { id: "ss713", type: "subsub", title: "Flags Work Anomalies", desc: "Identifies when something about the work is inconsistent or unusual." },
      { id: "ss721", type: "subsub", title: "Requests Input from Other Teams", desc: "Pulls information or approval needed from other groups or functions." },
      { id: "ss722", type: "subsub", title: "Shares Progress Transparently", desc: "Keeps others in the loop with visible status or updates." },
      { id: "ss723", type: "subsub", title: "Manages Interdependencies", desc: "Handles timing or content dependencies between parallel efforts." },
      { id: "ss731", type: "subsub", title: "Attaches Supporting Artifacts", desc: "Links related files, logs, or assets to provide context or evidence." },
      { id: "ss732", type: "subsub", title: "Summarizes Actions Taken", desc: "Captures a brief log of what was done and why." },
      { id: "ss733", type: "subsub", title: "Uploads to Central System", desc: "Pushes the results to a shared database or reporting system." },
      { id: "ss811", type: "subsub", title: "Runs Predefined Checks", desc: "Automated or manual quality checks ensure consistency and completeness." },
      { id: "ss812", type: "subsub", title: "Compares Against Requirements", desc: "Validates whether original goals and specs were met." },
      { id: "ss813", type: "subsub", title: "Logs Quality Issues", desc: "Captures failures or rework causes to inform future prevention." },
      { id: "ss821", type: "subsub", title: "Assigns Reviewer", desc: "Ensures the right person is selected to validate the output." },
      { id: "ss822", type: "subsub", title: "Facilitates Collaborative Review", desc: "Enables reviewers to add comments, markups, or suggested changes." },
      { id: "ss823", type: "subsub", title: "Collects Feedback and Decisions", desc: "Aggregates all approvals, rejections, and revision requests." },
      { id: "ss831", type: "subsub", title: "Tracks Required Approvers", desc: "Lists who must sign off before the work can move forward." },
      { id: "ss832", type: "subsub", title: "Confirms Sign-Off Completion", desc: "Checks that all necessary people have approved the work." },
      { id: "ss833", type: "subsub", title: "Escalates Delayed Approvals", desc: "Flags approvals that are overdue and may cause delays." },
      { id: "ss911", type: "subsub", title: "Applies Final Formatting", desc: "Standardizes layout, design, or structure for final presentation." },
      { id: "ss912", type: "subsub", title: "Double-Checks Output", desc: "Last confirmation that everything is correct and ready." },
      { id: "ss913", type: "subsub", title: "Locks the Version", desc: "Freezes the final version so it can’t be changed without control." },
      { id: "ss921", type: "subsub", title: "Prepares Presentation Materials", desc: "Creates slides, summaries, or delivery kits tailored to the audience." },
      { id: "ss922", type: "subsub", title: "Confirms Delivery Channel", desc: "Decides whether to send via email, web, portal, meeting, etc." },
      { id: "ss923", type: "subsub", title: "Schedules Delivery Timing", desc: "Chooses the right moment for optimal impact or alignment." },
      { id: "ss931", type: "subsub", title: "Delivers to Stakeholder", desc: "Shares the output with the requester, client, or relevant team." },
      { id: "ss932", type: "subsub", title: "Logs Delivery Confirmation", desc: "Tracks that the item was received and opened (if possible)." },
      { id: "ss933", type: "subsub", title: "Supports Post-Delivery Questions", desc: "Makes space to respond to clarifications or next steps." },
      //{ id: "ss1011", type: "subsub", title: "Compares Results vs. Goals", desc: "Checks if the actual outcome matched the intended success metrics." },
      //{ id: "ss1012", type: "subsub", title: "Runs Retrospective Analysis", desc: "Looks at what went well, what didn’t, and why — in a structured way." },
      //{ id: "ss1013", type: "subsub", title: "Identifies Systemic Issues", desc: "Spots recurring problems that could be solved at the root." },
      //{ id: "ss1021", type: "subsub", title: "Surveys Clients or Stakeholders", desc: "Asks people involved how satisfied they were and what could improve." },
      //{ id: "ss1022", type: "subsub", title: "Interviews Key Participants", desc: "Holds post-mortem conversations to gather context and nuance." },
      //{ id: "ss1023", type: "subsub", title: "Captures Testimonials or Insights", desc: "Records valuable stories, quotes, or discoveries made during work." },
      //{ id: "ss1031", type: "subsub", title: "Updates Training Materials", desc: "Incorporates lessons into how new staff are trained." },
      //{ id: "ss1032", type: "subsub", title: "Refines Process Templates", desc: "Improves forms, checklists, or templates based on findings." },
      //{ id: "ss1033", type: "subsub", title: "Shares Learning Company-Wide", desc: "Publishes findings so others can avoid similar pitfalls or replicate success." },

    ];

    // We'll create quick lookups for sub nodes and sub-sub nodes so we can easily filter by parent.
    function getSubsForMain(mId) {
      // e.g. "m2" => sub nodes with id "s2..."
      const digit = mId.substring(1);
      return subNodes.filter(n => n.id.charAt(1) === digit);
    }
    function getSubSubsForSub(sId) {
      // e.g. "s31" => sub-sub with "ss311", "ss312", ...
      const key = sId.substring(1); // "31"
      return subSubNodes.filter(n => n.id.substring(2,4) === key);
    }

    // ***********************
    // Single-pass layout logic
    // ***********************

    // 1) Place the first main node at a fixed x.
    mainNodes[0].x = mainStartX;

    // Helper: place sub nodes for a given main node and return the rightmost x.
    function placeSubBranch(mainNode) {
      // Find all sub nodes belonging to this main node.
      const subs = getSubsForMain(mainNode.id);
      if (!subs.length) return mainNode.x;  // no sub => no further to the right

      // Space them vertically around mainNode.y
      const n = subs.length;
      subs.forEach((sub, i) => {
        sub.x = mainNode.x + subOffsetX;  // place to the right of the main node
        sub.y = mainNode.y + (i - (n - 1) / 2) * subSpacingY;
      });

      // Now place each sub-sub branch. We'll track the rightmost x across all sub nodes.
      let rightMost = mainNode.x;
      subs.forEach(sub => {
        const subSubs = getSubSubsForSub(sub.id);
        if (!subSubs.length) {
          // no sub-sub => check sub.x
          if (sub.x > rightMost) rightMost = sub.x;
          return;
        }
        // We have sub-sub nodes. Place them horizontally in a vertical arrangement around sub.y.
        const countSS = subSubs.length;
        subSubs.forEach((ss, idx) => {
          ss.x = sub.x + subSubOffsetX;
          ss.y = sub.y + (idx - (countSS - 1) / 2) * subSubSpacingY;
        });
        // The rightmost sub-sub is at x = sub.x + subSubOffsetX
        // But if we want them chained horizontally, we'd do more logic. 
        // For now, they line up vertically. So let's see how far they get:
        const thisRight = subSubs[0].x; // all the same x in this approach
        if (thisRight > rightMost) rightMost = thisRight;
      });

      return rightMost;
    }

    // 2) For each main node in order, place its sub & sub-sub, track the rightmost x, 
    //    and position the next main node.
    let currentRight = placeSubBranch(mainNodes[0]);
    for (let i = 1; i < mainNodes.length; i++) {
      // put mainNodes[i] to the right of currentRight
      mainNodes[i].x = currentRight + mainSpacing;
      // now place its sub branch
      const newRight = placeSubBranch(mainNodes[i]);
      // update currentRight
      currentRight = Math.max(currentRight, newRight, mainNodes[i].x);
    }

    // Now we have x & y for all nodes in a single pass. 
    // Create a lookup for connections.
    const allNodesCombined = mainNodes.concat(subNodes, subSubNodes);
    const nodeById = {};
    allNodesCombined.forEach(n => nodeById[n.id] = n);

    // ***********************
    // 2. Define Connections
    // ***********************
    const connections = [
      { source: "m1", target: "m2" },
      { source: "m2", target: "s21" },
      { source: "m2", target: "s22" },
      { source: "m2", target: "s23" },
      { source: "s21", target: "ss211" },
      { source: "s21", target: "ss212" },
      { source: "s21", target: "ss213" },
      { source: "s22", target: "ss221" },
      { source: "s22", target: "ss222" },
      { source: "s22", target: "ss223" },
      { source: "s23", target: "ss231" },
      { source: "s23", target: "ss232" },
      { source: "s23", target: "ss233" },
      { source: "ss211", target: "m3" },
      { source: "ss212", target: "m3" },
      { source: "ss213", target: "m3" },
      { source: "ss221", target: "m3" },
      { source: "ss222", target: "m3" },
      { source: "ss223", target: "m3" },
      { source: "ss231", target: "m3" },
      { source: "ss232", target: "m3" },
      { source: "ss233", target: "m3" },
      { source: "m3", target: "s31" },
      { source: "m3", target: "s32" },
      { source: "m3", target: "s33" },
      { source: "s31", target: "ss311" },
      { source: "s31", target: "ss312" },
      { source: "s31", target: "ss313" },
      { source: "s32", target: "ss321" },
      { source: "s32", target: "ss322" },
      { source: "s32", target: "ss323" },
      { source: "s33", target: "ss331" },
      { source: "s33", target: "ss332" },
      { source: "s33", target: "ss333" },
      { source: "ss311", target: "m4" },
      { source: "ss312", target: "m4" },
      { source: "ss313", target: "m4" },
      { source: "ss321", target: "m4" },
      { source: "ss322", target: "m4" },
      { source: "ss323", target: "m4" },
      { source: "ss331", target: "m4" },
      { source: "ss332", target: "m4" },
      { source: "ss333", target: "m4" },
	  
	  { source: "m4", target: "s41" },
	  { source: "m4", target: "s42" },
	  { source: "m4", target: "s43" },
	  { source: "s41", target: "ss411" },
	  { source: "s41", target: "ss412" },
	  { source: "s41", target: "ss413" },
	  { source: "s42", target: "ss421" },
	  { source: "s42", target: "ss422" },
	  { source: "s42", target: "ss423" },
	  { source: "s43", target: "ss431" },
	  { source: "s43", target: "ss432" },
	  { source: "s43", target: "ss433" },
	  { source: "ss411", target: "m5" },
	  { source: "ss412", target: "m5" },
	  { source: "ss413", target: "m5" },
	  { source: "ss421", target: "m5" },
	  { source: "ss422", target: "m5" },
	  { source: "ss423", target: "m5" },
	  { source: "ss431", target: "m5" },
	  { source: "ss432", target: "m5" },
	  { source: "ss433", target: "m5" },
	  
	  { source: "m5", target: "s51" },
      { source: "s51", target: "ss511" },
      { source: "s51", target: "ss512" },
      { source: "s51", target: "ss513" },
      { source: "m5", target: "s52" },
      { source: "s52", target: "ss521" },
      { source: "s52", target: "ss522" },
      { source: "s52", target: "ss523" },
      { source: "m5", target: "s53" },
      { source: "s53", target: "ss531" },
      { source: "s53", target: "ss532" },
      { source: "s53", target: "ss533" },
      { source: "ss511", target: "m6" },
	  { source: "ss512", target: "m6" },
	  { source: "ss513", target: "m6" },
	  { source: "ss521", target: "m6" },
	  { source: "ss522", target: "m6" },
	  { source: "ss523", target: "m6" },
	  { source: "ss531", target: "m6" },
	  { source: "ss532", target: "m6" },
	  { source: "ss533", target: "m6" },
      
	  { source: "m6", target: "s61" },
      { source: "s61", target: "ss611" },
      { source: "s61", target: "ss612" },
      { source: "s61", target: "ss613" },
      { source: "m6", target: "s62" },
      { source: "s62", target: "ss621" },
      { source: "s62", target: "ss622" },
      { source: "s62", target: "ss623" },
      { source: "m6", target: "s63" },
      { source: "s63", target: "ss631" },
      { source: "s63", target: "ss632" },
      { source: "s63", target: "ss633" },
      { source: "ss611", target: "m7" },
	  { source: "ss612", target: "m7" },
	  { source: "ss613", target: "m7" },
	  { source: "ss621", target: "m7" },
	  { source: "ss622", target: "m7" },
	  { source: "ss623", target: "m7" },
	  { source: "ss631", target: "m7" },
	  { source: "ss632", target: "m7" },
	  { source: "ss633", target: "m7" },
      
      { source: "m7", target: "s71" },
      { source: "s71", target: "ss711" },
      { source: "s71", target: "ss712" },
      { source: "s71", target: "ss713" },
      { source: "m7", target: "s72" },
      { source: "s72", target: "ss721" },
      { source: "s72", target: "ss722" },
      { source: "s72", target: "ss723" },
      { source: "m7", target: "s73" },
      { source: "s73", target: "ss731" },
      { source: "s73", target: "ss732" },
      { source: "s73", target: "ss733" },
      { source: "ss711", target: "m8" },
	  { source: "ss712", target: "m8" },
	  { source: "ss713", target: "m8" },
	  { source: "ss721", target: "m8" },
	  { source: "ss722", target: "m8" },
	  { source: "ss723", target: "m8" },
	  { source: "ss731", target: "m8" },
	  { source: "ss732", target: "m8" },
	  { source: "ss733", target: "m8" },
      
      { source: "m8", target: "s81" },
      { source: "s81", target: "ss811" },
      { source: "s81", target: "ss812" },
      { source: "s81", target: "ss813" },
      { source: "m8", target: "s82" },
      { source: "s82", target: "ss821" },
      { source: "s82", target: "ss822" },
      { source: "s82", target: "ss823" },
      { source: "m8", target: "s83" },
      { source: "s83", target: "ss831" },
      { source: "s83", target: "ss832" },
      { source: "s83", target: "ss833" },
      { source: "ss811", target: "m9" },
	  { source: "ss812", target: "m9" },
	  { source: "ss813", target: "m9" },
	  { source: "ss821", target: "m9" },
	  { source: "ss822", target: "m9" },
	  { source: "ss823", target: "m9" },
	  { source: "ss831", target: "m9" },
	  { source: "ss832", target: "m9" },
	  { source: "ss833", target: "m9" },
      
      { source: "m9", target: "s91" },
      { source: "s91", target: "ss911" },
      { source: "s91", target: "ss912" },
      { source: "s91", target: "ss913" },
      { source: "m9", target: "s92" },
      { source: "s92", target: "ss921" },
      { source: "s92", target: "ss922" },
      { source: "s92", target: "ss923" },
      { source: "m9", target: "s93" },
      { source: "s93", target: "ss931" },
      { source: "s93", target: "ss932" },
      { source: "s93", target: "ss933" },
      { source: "ss911", target: "m10" },
	  { source: "ss912", target: "m10" },
	  { source: "ss913", target: "m10" },
	  { source: "ss921", target: "m10" },
	  { source: "ss922", target: "m10" },
	  { source: "ss923", target: "m10" },
	  { source: "ss931", target: "m10" },
	  { source: "ss932", target: "m10" },
	  { source: "ss933", target: "m10" },
      

    ];

    // ***********************
    // 3. Draw the Nodes and Labels
    // ***********************
    g.selectAll("circle.main")
      .data(mainNodes)
      .enter()
      .append("circle")
      .attr("class", "main-node")
      .attr("cx", d => d.x)
      .attr("cy", d => d.y)
      .attr("r", mainRadius);

    g.selectAll("text.main")
      .data(mainNodes)
      .enter()
      .append("text")
      .attr("class", "node-text")
      .attr("x", d => d.x)
      .attr("y", d => d.y + mainRadius + mainTextOffset)
      .text(d => d.title);

    g.selectAll("circle.sub")
      .data(subNodes)
      .enter()
      .append("circle")
      .attr("class", "sub-node")
      .attr("cx", d => d.x)
      .attr("cy", d => d.y)
      .attr("r", subRadius);

    g.selectAll("text.sub")
      .data(subNodes)
      .enter()
      .append("text")
      .attr("class", "node-text")
      .attr("x", d => d.x)
      .attr("y", d => d.y + subRadius + subTextOffset)
      .text(d => d.title);

    g.selectAll("circle.subsub")
      .data(subSubNodes)
      .enter()
      .append("circle")
      .attr("class", "sub-sub-node")
      .attr("cx", d => d.x)
      .attr("cy", d => d.y)
      .attr("r", subSubRadius);

    g.selectAll("text.subsub")
      .data(subSubNodes)
      .enter()
      .append("text")
      .attr("class", "node-text")
      .attr("x", d => d.x)
      .attr("y", d => d.y + subSubRadius + subSubTextOffset)
      .text(d => d.title);

    // ***********************
    // 4. Draw the Connections
    // ***********************
    function getRadius(node) {
      if (node.type === "main") return mainRadius;
      else if (node.type === "sub") return subRadius;
      else if (node.type === "subsub") return subSubRadius;
      else return subRadius;
    }
    function computeConnectionEndpoints(source, target) {
      const dx = target.x - source.x;
      const dy = target.y - source.y;
      const angle = Math.atan2(dy, dx);
      const sourceRadius = getRadius(source);
      const targetRadius = getRadius(target);
      const startX = source.x + Math.cos(angle) * sourceRadius;
      const startY = source.y + Math.sin(angle) * sourceRadius;
      const endX = target.x - Math.cos(angle) * targetRadius;
      const endY = target.y - Math.sin(angle) * targetRadius;
      return { startX, startY, endX, endY };
    }

    connections.forEach(conn => {
      const sourceNode = nodeById[conn.source];
      const targetNode = nodeById[conn.target];
      if (sourceNode && targetNode) {
        const { startX, startY, endX, endY } = computeConnectionEndpoints(sourceNode, targetNode);
        g.append("line")
         .attr("class", "connector")
         .attr("x1", startX)
         .attr("y1", startY)
         .attr("x2", endX)
         .attr("y2", endY);
      }
    });

    // ***********************
    // 5. Add Tooltip Functionality
    // ***********************
    const tooltip = d3.select("#tooltip");
    g.selectAll("circle.main-node, circle.sub-node, circle.sub-sub-node")
      .on("mouseover", function(event, d) {
        tooltip.style("display", "block")
               .html(d.desc || d.title);
        tooltip.style("left", (event.pageX + 10) + "px")
               .style("top", (event.pageY + 10) + "px");
      })
      .on("mousemove", function(event) {
        tooltip.style("left", (event.pageX + 10) + "px")
               .style("top", (event.pageY + 10) + "px");
      })
      .on("mouseout", function() {
        tooltip.style("display", "none");
      });

    // ***********************
    // 6. Enable Pan and Zoom
    // ***********************
    const zoomBehavior = d3.zoom()
                           .scaleExtent([0.5, 3])
                           .on("zoom", event => {
                             g.attr("transform", event.transform);
                           });
    svg.call(zoomBehavior)
       .on("start.zoom", () => svg.style("cursor", "grabbing"))
       .on("end.zoom", () => svg.style("cursor", "grab"));

  </script>
</body>
</html>
